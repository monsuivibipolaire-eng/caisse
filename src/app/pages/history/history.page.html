<ion-content [fullscreen]="true" [scrollY]="false" class="bg-slate-50">
  <div class="absolute inset-0 flex flex-col w-full h-full overflow-hidden">
    
    <div class="bg-white border-b border-slate-100 flex flex-col shrink-0 z-20 shadow-sm">
      
      <div class="px-5 py-3 flex items-center gap-3">
        <button routerLink="/dashboard" class="h-10 w-10 bg-slate-50 rounded-xl flex items-center justify-center text-slate-600 tap-effect hover:bg-slate-100 transition-colors">
          <ion-icon name="arrow-back-outline" class="text-xl"></ion-icon>
        </button>
        <h1 class="font-bold text-lg text-slate-800">Historique</h1>
      </div>

      <div class="px-5 pb-4 flex flex-col gap-3">
        
        <ion-segment [value]="paymentFilter$ | async" (ionChange)="onPaymentChange($event)" mode="ios" class="h-8">
          <ion-segment-button value="ALL">
            <ion-label class="text-xs font-bold">Tout</ion-label>
          </ion-segment-button>
          <ion-segment-button value="ESPECES">
            <ion-label class="text-xs font-bold">Espèces</ion-label>
          </ion-segment-button>
          <ion-segment-button value="CARTE">
            <ion-label class="text-xs font-bold">Carte</ion-label>
          </ion-segment-button>
        </ion-segment>

        <div class="flex items-center gap-2 overflow-x-auto no-scrollbar">
          
          <button (click)="setRange('today')" 
            [class]="currentRange === 'today' ? 'bg-indigo-600 text-white shadow-md shadow-indigo-200' : 'bg-slate-100 text-slate-600 border border-slate-200'"
            class="px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition-all tap-effect">
            Aujourd'hui
          </button>
          
          <button (click)="setRange('yesterday')" 
            [class]="currentRange === 'yesterday' ? 'bg-indigo-600 text-white shadow-md shadow-indigo-200' : 'bg-slate-100 text-slate-600 border border-slate-200'"
            class="px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition-all tap-effect">
            Hier
          </button>
          
          <button (click)="setRange('week')" 
            [class]="currentRange === 'week' ? 'bg-indigo-600 text-white shadow-md shadow-indigo-200' : 'bg-slate-100 text-slate-600 border border-slate-200'"
            class="px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition-all tap-effect">
            7 Jours
          </button>

          <div class="relative ml-auto">
             <ion-datetime-button datetime="datetime" class="scale-90 origin-right"></ion-datetime-button>
          </div>
        </div>

      </div>
    </div>

    <div class="px-4 py-3 shrink-0 z-10 grid grid-cols-2 gap-4 bg-slate-50/50">
        <div class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm flex flex-col">
          <p class="text-[10px] uppercase font-bold text-slate-400">Total Période</p>
          <p class="text-lg font-extrabold text-indigo-600">
            <ng-container *ngIf="stats$ | async as stats">{{ stats.totalRevenue | currency:'EUR':'symbol':'1.0-0' }}</ng-container>
          </p>
        </div>
        <div class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm flex flex-col">
          <p class="text-[10px] uppercase font-bold text-slate-400">Nombre de Ventes</p>
          <p class="text-lg font-extrabold text-emerald-600">
            <ng-container *ngIf="stats$ | async as stats">{{ stats.count }}</ng-container>
          </p>
        </div>
    </div>

    <div class="flex-1 overflow-y-auto px-4 pb-safe space-y-3 bg-slate-50">
      <ng-container *ngIf="sales$ | async as sales; else loading">
        
        <div *ngIf="sales.length === 0" class="flex flex-col items-center justify-center h-48 text-slate-400 gap-2">
          <ion-icon name="receipt-outline" class="text-4xl opacity-50"></ion-icon>
          <p class="font-medium text-sm">Aucune vente trouvée</p>
        </div>

        <div *ngFor="let sale of sales" (click)="openReceipt(sale)" class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex items-center justify-between active:scale-98 transition-transform cursor-pointer hover:border-indigo-100">
          <div class="flex items-center gap-4">
            <div class="h-10 w-10 rounded-full flex items-center justify-center font-bold text-xs shadow-sm"
                 [ngClass]="sale.paymentMethod === 'CARTE' ? 'bg-blue-50 text-blue-600' : 'bg-amber-50 text-amber-600'">
              <ion-icon [name]="sale.paymentMethod === 'CARTE' ? 'card-outline' : 'cash-outline'" class="text-lg"></ion-icon>
            </div>
            <div>
              <p class="font-bold text-slate-800 text-sm">
                {{ sale.date?.seconds * 1000 | date:'HH:mm' }} 
                <span class="text-slate-400 font-normal ml-1 text-xs">{{ sale.itemCount }} art.</span>
              </p>
              <p class="text-[10px] text-slate-400 font-mono">ID: {{ sale.id | slice:0:6 }}</p>
            </div>
          </div>
          <span class="font-bold text-slate-800">{{ sale.total | currency:'EUR':'symbol':'1.2-2' }}</span>
        </div>
      </ng-container>
      
      <ng-template #loading>
        <div class="text-center py-10 text-slate-400">Chargement...</div>
      </ng-template>
    </div>

  </div>

  <ion-modal [keepContentsMounted]="true">
    <ng-template>
      <ion-datetime id="datetime" presentation="date" (ionChange)="onDateChange($event)"></ion-datetime>
    </ng-template>
  </ion-modal>

</ion-content>
